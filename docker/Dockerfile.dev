# Development Dockerfile for Hyperfocus Agent
# Optimized for live code editing without rebuilds
FROM python:3.12-slim AS dev

ARG USER_ID=1000
ARG GROUP_ID=1000
ARG USERNAME=hyperfocus

RUN apt update && apt install -y --no-install-recommends \
    curl wget ripgrep vim

# Install Poetry
RUN pip install poetry==1.7.1 beautifulsoup4 ripgrepy

# Set working directory
WORKDIR /app

# Copy dependency files first (these change less frequently)
COPY pyproject.toml poetry.lock ./
COPY README.md ./

# Configure Poetry to not create virtual env (we're already in a container)
RUN poetry config virtualenvs.create false

# Install dependencies (but don't install the package yet)
# This layer will be cached unless dependencies change
RUN poetry install --no-interaction --no-ansi --no-root

# Source code will be mounted at runtime via volume
# This means changes to source code don't require rebuilds

# Create a safe test workspace directory
RUN mkdir -p /workspace/test_area

# Copy and setup entrypoint that will install package after volume mount
COPY docker/entrypoint-dev.sh /entrypoint-dev.sh
RUN chmod +x /entrypoint-dev.sh

# Create a non-root user that matches the host UID/GID so mounted files are not owned by root
RUN if getent group "$GROUP_ID" >/dev/null; then \
        GROUP_NAME=$(getent group "$GROUP_ID" | cut -d: -f1); \
    else \
        GROUP_NAME="$USERNAME"; \
        groupadd -g "$GROUP_ID" "$GROUP_NAME"; \
    fi && \
    useradd -m -u "$USER_ID" -g "$GROUP_NAME" "$USERNAME" && \
    chown -R "$USERNAME":"$GROUP_NAME" /app /workspace

ENV PATH="/home/${USERNAME}/.local/bin:${PATH}"
USER $USERNAME

# Set the workspace as working directory for testing
WORKDIR /app

# Use entrypoint to install package in editable mode on startup
ENTRYPOINT ["/entrypoint-dev.sh"]
