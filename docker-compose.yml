services:
  hyperfocus:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: hyperfocus
    environment:
      LOCAL_OPENAI_BASE_URL: ${LOCAL_OPENAI_BASE_URL:-""}
      LOCAL_OPENAI_API_KEY: ${LOCAL_OPENAI_API_KEY:-""}
      LOCAL_OPENAI_MODEL: ${LOCAL_OPENAI_MODEL:-""}

      REMOTE_OPENAI_BASE_URL: ${REMOTE_OPENAI_BASE_URL:-""}
      REMOTE_OPENAI_API_KEY: ${REMOTE_OPENAI_API_KEY:-""}
      REMOTE_OPENAI_MODEL: ${REMOTE_OPENAI_MODEL:-""}

      MULTIMODAL_OPENAI_BASE_URL: ${MULTIMODAL_OPENAI_BASE_URL:-""}
      MULTIMODAL_OPENAI_API_KEY: ${MULTIMODAL_OPENAI_API_KEY:-""}
      MULTIMODAL_OPENAI_MODEL: ${MULTIMODAL_OPENAI_MODEL:-""}

      LLM_ROUTER_THRESHOLD: ${LLM_ROUTER_THRESHOLD:-""}

      # Phoenix observability
      PHOENIX_COLLECTOR_ENDPOINT: http://phoenix:6006
    networks:
      - hyperfocus-net
    volumes:
      - ./workspace:/workspace
    stdin_open: true
    tty: true
    # Resource limits for safety
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Dev mode: live code editing without rebuilds
  hyperfocus-dev:
    extends: hyperfocus
    container_name: hyperfocus-dev
    build:
      context: .
      dockerfile: docker/Dockerfile.dev
      args:
        USER_ID: ${HOST_UID:-1000}
        GROUP_ID: ${HOST_GID:-1000}
    environment:
      LOCAL_OPENAI_BASE_URL: ${LOCAL_OPENAI_BASE_URL:-""}
      LOCAL_OPENAI_API_KEY: ${LOCAL_OPENAI_API_KEY:-""}
      LOCAL_OPENAI_MODEL: ${LOCAL_OPENAI_MODEL:-""}

      REMOTE_OPENAI_BASE_URL: ${REMOTE_OPENAI_BASE_URL:-""}
      REMOTE_OPENAI_API_KEY: ${REMOTE_OPENAI_API_KEY:-""}
      REMOTE_OPENAI_MODEL: ${REMOTE_OPENAI_MODEL:-""}

      MULTIMODAL_OPENAI_BASE_URL: ${MULTIMODAL_OPENAI_BASE_URL:-""}
      MULTIMODAL_OPENAI_API_KEY: ${MULTIMODAL_OPENAI_API_KEY:-""}
      MULTIMODAL_OPENAI_MODEL: ${MULTIMODAL_OPENAI_MODEL:-""}

      LLM_ROUTER_THRESHOLD: ${LLM_ROUTER_THRESHOLD:-""}

      # Phoenix observability
      PHOENIX_COLLECTOR_ENDPOINT: http://phoenix:6006
    networks:
      - hyperfocus-net
    volumes:
      # Mount source code read-write for live editing
      - ./src:/app/src:rw
      # Mount pyproject.toml for package metadata
      - ./pyproject.toml:/app/pyproject.toml:ro
      # Persistent workspace for agent operations
      - ./workspace:/workspace
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"

  # Phoenix observability server
  phoenix:
    image: arizephoenix/phoenix:latest
    container_name: phoenix
    ports:
      - "6006:6006"  # Phoenix UI
      - "4317:4317"  # gRPC collector
    environment:
      - PHOENIX_WORKING_DIR=/phoenix-data
    volumes:
      - phoenix-data:/phoenix-data
    networks:
      - hyperfocus-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6006"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Simple HTTP server for serving test assets with proper UTF-8 encoding
  asset-server:
    image: python:3.12-slim
    container_name: hyperfocus-asset-server
    working_dir: /assets
    volumes:
      - ./workspace/sample_files:/assets:ro
      - ./docker/utf8_server.py:/usr/local/bin/utf8_server.py:ro
    ports:
      - "8080:8080"
    command: python /usr/local/bin/utf8_server.py 8080
    networks:
      - hyperfocus-net

  # Crawl4AI service for web scraping tasks
  crawl4ai:
    image: unclecode/crawl4ai:latest
    container_name: crawl4ai
    ports:
      - "11235:11235"
    shm_size: 1g
    networks:
      - hyperfocus-net

volumes:
  # Named volume for test workspace - isolated from host filesystem
  test-workspace:
  dev-workspace:
  # Phoenix data persistence
  phoenix-data:

networks:
  hyperfocus-net:
    driver: bridge
